##########################
d-manager: Dietary manager
##########################

食事の記録や食品情報を管理をするための CLI ツール群。

日々の食事を管理するために使えます。

***************
簡単な使い方
***************

以下のような YAML 形式のファイルに食品情報を記述して、コマンドの引数として渡すと、現在時刻の食事としてデータベースに食事データを記録します。

.. code-block:: shell

    $ cat meal.yaml
    food:
      - product, 13001, 2.0
      - product, 15001, 1
      - stofc2015, 16045, 1.5
    $ d-manager add meal -m meal.yaml
    以下の食品を登録します。よろしいですか?
    datetime: 2017-09-18 21:48:14.980520
      1), 製造者: 株式会社 明治, 商品名: 明治ブルガリアヨーグルトLB81プレーン, 量: 200.0 g, 熱量: 124.0 kcal, たんぱく質: 6.8 g, 脂質: 6.0 g, 炭水化物: 10.6 g, 食塩相当量: 0.26 g
      2), 製造者: 日本ケロッグ合同会社, 商品名: フルーツグラノラ ハーフ, 量: 40.0 g, 熱量: 154.0 kcal, たんぱく質: 2.5 g, 脂質: 1.2 g, 炭水化物: 34.1 g, 食塩相当量: 0.3 g
      3), 分類: し好飲料類 コーヒー・ココア類, 食品名: コーヒー 浸出液, 量: 150.0 g, 熱量: 6.0 kcal, たんぱく質: 0.3 g, 脂質: 0.0 g, 炭水化物: 1.1 g, 食塩相当量: 0.0 g
    [Y/n]> Y

食事内容には、どの食品データベースか、データベース内の食品 ID、食品単位に対する量を記述します。
食品データベース、食事データベース等の作成方法や設定方法は後述します。

データベースに記録した食事は、以下のように一覧で csv で閲覧できます。

.. code-block:: shell

    $ d-manager view meal -m meals
    date,time,food_name,amount,energy [kcal],protein [g],lipid [g],carbohydrate [g],salt_equivalent [g]
    2017-09-18,21:48,発酵乳,200.0 gram,124.0,6.8,6.0,10.6,0.26
    2017-09-18,21:48,朝食シリアル,40.0 gram,154.0,2.5,1.2,34.1,0.3
    2017-09-18,21:48,コーヒー 浸出液,150.0 gram,6.0,0.3,0.0,1.1,0.0

また、一日単位で統計も確認できます。

.. code-block:: shell

    $ d-manager view meal -m meals -s
    date,energy [kcal],protein [g],lipid [g],carbohydrate [g],salt_equivalent [g]
    2017-09-17,1814.0,80.2,53.8,157.3,4.82
    2017-09-18,414.0,16.7,13.2,57.4,0.82

食事を記録するときに日時を指定するときは、以下のように `datetime` キーのハッシュマップに日付を記述します。

.. code-block:: shell

    $ cat meal.yaml
    datetime: 2017-09-16
    food:
      - product, 13001, 2.0
      - product, 15001, 1
      - stofc2015, 16045, 1.5

また、調整として栄養素やメモも食事の記録に追加できます。

.. code-block:: shell

    $ cat meal.yaml
    datetime: 2017-09-16
    food:
      - stofc2015, 1001, 0.5
      - stofc2015, 5001, 1
      - product, 10001, 2.5
    adjust:
      energy: 100kcal
      protein: 1.0g
      lipid: 10.0g
      carbohydrate: 10.0g
      salt: 10.0g
    memo:


***************
食品データベース
***************

現在、管理可能な食品データは以下の通りです。

* 文部科学省が公開している「日本食品標準成分表2015年版（七訂）」
  
  * 配布されている Excel ファイルを利用可能な形式に変換

* 市販食品（加工食品、生鮮食品）
      
  * 対話的に食品情報をデータベースに追加

詳しい食品の追加方法は後述します。

「食品表示法」及び「食品表示基準」で定められた栄養成分表示を参考にして、義務表示である基本5項目の栄養素を中心とした項目で食品情報を登録可能です。

***************
動作環境
***************

以下の環境で動作確認済みです。

* Debian GNU/Linux 8 (jessie)
* Python 3.6.1

必要な外部パッケージは `requirements.txt` を参考のこと。

***************
インストール
***************

`bin/d-manager` へのシンボリックリンクをパスの通ったディレクトリに張る。

必要なプラグインをインストール

.. code-block:: shell

   $ pip install -r requirements.txt

******************************
事前設定
******************************

環境変数 `D_MANAGER_PATH` で指定されたパス以下に設定ファイル `config` を配置します。

設定ファイル `config` は以下のような YAML 形式で書きます。

.. code-block:: yaml

   food_book:
     -
       file: /home/user/dev/.d-manager/stofc2015
       type: stofc2015
     -
       file: /home/user/dev/.d-manager/product_food_book
       type: product
   meal_book: /home/user/.d-manager/meals

各、Key の意味は以下のようになっています。

.. code-block:: yaml

   food_book:  # 食品データを収載するデータベースのリスト
     -
       type:  #  食品データベースの種別
       file:  #  データベースファイル
       prefix:  # 食品の ID につける接頭辞
   meal_book:  # 食事データを格納するファイル

食品データの種別 `type` の値には `stofc2015` が「日本食品標準成分表2015年版」で、 `product` が市販食品のデータです。

食品の ID について
=============================================

食品データはデータベース毎に識別番号（ID）が採番されます（例: 13001）、ひとつのデータベース内の食品はこの番号で一意に特定出来ます。
しかし、複数のデータベース全体では ID が重複する可能性があります。
そのため、食事を記録するときは ID 前にどの食品データベースの ID かを示す必要があります。

設定ファイル内の `type` で指定した種別は食事記録時にこの目的にも利用します。

******************************
食品データベース作成
******************************

市販食品の管理
=============================================

追加
--------------------------------------------

コマンド `d-manager add product_food` で市販食品を対話的に登録出来ます。
食品データを保存するファイルは設定ファイルに `type: product` で記述した食品データベースです。

.. code-block:: shell

   $ d-manager add product_food
   /home/user/.d-manager/product_food_book を読み込みます。
   食品のグループを番号で選択してください。

    1: 穀類, 2: いも及びでん粉類, 3: 砂糖及び甘味類, 4: 豆類,
    5: 種実類, 6: 野菜類, 7: 果実類, 8: きのこ類,
    9: 藻類, 10: 魚介類, 11: 肉類, 12: 卵類,
    13: 乳類, 14: 油脂類, 15: 菓子類, 16: し好飲料類,
    17: 調味料及び香辛料類, 18: 調理加工食品類

   ?> 13
   13: 乳類 が選択されました。
   ...(中略)...
   以下をグループ「乳類」登録しますが、よろしいですか？
   製造者: 株式会社 明治
   商品名: 明治ブルガリアヨーグルトLB81プレーン
   量: 100.0 g
   熱量: 62.0 kcal
   たんぱく質: 3.4 g
   脂質: 3.0 g
   炭水化物: 5.3 g
   食塩相当量: 0.13 g
   [Y/n]> Y
   ID:13001 として登録されました。
   引き続き登録しますか？
   [Y/n]> n


内容の確認
--------------------------------------------

以下のコマンドで市販食品のデータベースの内容を CSV 形式で閲覧出来ます。

.. code-block:: shell

   $ d-manager view product_food -i /home/usr/.d-manager/product_food_book -t csv
   group_id,food_id,maker,product_name,common_name,name,amount,energy,protein,lipid,carbohydrate,salt_equivalent
   13,13001,株式会社 明治,明治ブルガリアヨーグルトLB81プレーン,発酵乳,株式会社 明治%明治ブルガリアヨーグルトLB81プレーン,100.0 gram,62 kcal,3.4 g,3.0 g,5.3 g,0.13 g

ここで表示される、ラベル `food_id` 行の値が食事を記録するときの食品の ID である。


「日本食品標準成分表2015年版（七訂）」の管理
=============================================

Excel ファイルの入手
--------------------------------------------

日本食品標準成分表2015年版（七訂）の Excel ファイルは以下から入手可能。

`第2章　日本食品標準成分表　Exceｌ（日本語版）：文部科学省 <http://www.mext.go.jp/a_menu/syokuhinseibun/1365420.htm>`_

上記からダウンロードできる「一括ダウンロード（Excel：日本語）  （Excel:917KB）」には全ての食品群の食品が記載されているので、これを利用する。

Excel ファイルを変換
--------------------------------------------

以下のコマンドで日本食品標準成分表2015年版（七訂）の Excel ファイルをスクリプトが利用できる形式のファイルに変換できます。

.. code-block:: shell

    $ d-manager convert stofc2015_excel -i 1365334_1r10.xlsx -o stofc2015
    食品群 穀類: 159 件処理しました。
    食品群 いも及びでん粉類: 62 件処理しました。
    食品群 砂糖及び甘味類: 27 件処理しました。
    食品群 豆類: 93 件処理しました。
    食品群 種実類: 43 件処理しました。
    食品群 野菜類: 362 件処理しました。
    食品群 果実類: 174 件処理しました。
    食品群 きのこ類: 49 件処理しました。
    食品群 藻類: 53 件処理しました。
    食品群 魚介類: 419 件処理しました。
    食品群 肉類: 291 件処理しました。
    食品群 卵類: 20 件処理しました。
    食品群 乳類: 58 件処理しました。
    食品群 油脂類: 31 件処理しました。
    食品群 菓子類: 141 件処理しました。
    食品群 し好飲料類: 58 件処理しました。
    食品群 調味料及び香辛料類: 129 件処理しました。
    食品群 調理加工食品類: 22 件処理しました。
    合計: 2191 件処理しました。(2.4 sec)

    Process finished with exit code 0

内容を確認
--------------------------------------------

.. code-block:: shell

    $ d-manager view stofc2015_food -i stofc2015 -t csv
    group_id,food_id,groups,tags,amount,energy,protein,lipid,carbohydrate,salt_equivalent
    1,1001,穀類,アマランサス 玄穀,100 gram,358.0 kcal,12.7 g,6.0 g,64.9 g,0.0 g
    1,1002,穀類,あわ 精白粒,100 gram,367.0 kcal,11.2 g,4.4 g,69.7 g,0.0 g
    1,1003,穀類,あわ あわもち,100 gram,214.0 kcal,5.1 g,1.3 g,45.3 g,0.0 g

ここで表示される、ラベル `food_id` 行の値が食事を記録するときの食品の ID である。

市販食品の管理基準について
=============================================

「食品表示法」で表示義務となっている事項から、必要だと思われる事項をこのツールでは管理している。

「食品表示法」（平成25年法律第70号）及び「食品表示基準」（平成27年内閣府令第10号）では食品の表示に関して種々の基準や義務を定めている。
特に、「栄養成分表示」が義務化され、以下の 5 項目の表示が義務となっている。

* エネルギー（kcal or J）
* タンパク質（g）
* 脂質（g）
* 炭水化物（g）
* 食塩相当量（g）

さらに、名称や内容量、販売者を示す「一括表示」にも各種の基準や指示が定められている。

参考

* `食品表示法等(法令及び一元化情報)｜消費者庁 <http://www.caa.go.jp/foods/index18.html>`_
* `食品表示法 <http://law.e-gov.go.jp/htmldata/H25/H25HO070.html>`_
* `食品表示基準 <http://law.e-gov.go.jp/htmldata/H27/H27F10001000010.html>`_

***************
参考
***************

法令など
=============================================

* `食品表示法（平成二十五年六月二十八日法律第七十号） <http://law.e-gov.go.jp/htmldata/H25/H25HO070.html>`_
* `食品表示基準（平成二十七年三月二十日内閣府令第十号） <http://law.e-gov.go.jp/htmldata/H27/H27F10001000010.html>`_

栄養成分などの具体的な表示項目についての指示は「食品表示基準」に記載されている。


ガイドラインなど
=============================================

* `食品表示法等(法令及び一元化情報)｜消費者庁 <http://www.caa.go.jp/foods/index18.html>`_
* `栄養成分表示ハンドブック - 東京都福祉保健局 <http://www.fukushihoken.metro.tokyo.jp/shokuhin/hyouji/kyouzai/files/eiyouseibun_handbook.pdf>`_

「栄養成分表示」での各栄養素の最小表示桁および端数処理は消費者庁の通知「食品表示基準について（平成27年3月30日消食表第139号）」にあり。